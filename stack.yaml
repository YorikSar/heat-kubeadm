heat_template_version: 2017-02-24
description: Deploy Kubernetes cluster with kubeadm

parameters:
    key_name:
        type: string
        label: Key Name
        description: SSH key to be used for all instances
        default: ytl
    image:
        type: string
        label: Image
        description: Image to be used
        default: ubuntu-16-04-amd64-cloudimg    
    master_flavor:
        type: string
        label: Master Instance Type
        description: Type of instance (flavor) to deploy master node
        default: m1.small
    master_floating_ip:
        type: string
        label: Master Floating IP ID
        description: Floating IP for master node
        default: 24776f99-7599-4bdd-8a1a-1a551180eb4a
    slave_count:
        type: number
        label: Slave Count
        description: Number of slaves
        default: 3
    slave_flavor:
        type: string
        label: Slave Instance Type
        description: Type of instance (flavor) to deploy slave nodes
        default: m1.small
    slave_floating_ips:
        type: comma_delimited_list
        label: Slave Floating IP IDs
        description: Floating IP for master node
        default: 851660f0-3648-4560-9403-c68647e4aa99,32cc96ef-8590-4785-b660-c6e773c97f3d,6c9d42cb-ad7e-46dd-aca8-9a5cc628e5de
    public_network_id:
        type: string
        description: ID of the public network
        default: public
    resource_prefix:
        type: string
        description: Prefix to add to all resources
        default: k8s-
    dns_nameservers:
        type: comma_delimited_list
        label: DNS Nameservers
        description: DNS nameservers to use on nodes
        default: 8.8.8.8

resources:
    random_string:
        type: OS::Heat::RandomString
        properties:
            length: 8
            sequence: lowercase
    ##### Network #####
    internal_net:
        type: OS::Neutron::Net
        properties:
            admin_state_up: true
            name:
                str_replace:
                    template: $prefix$random-network
                    params:
                        $prefix: { get_param: resource_prefix }
                        $random: { get_resource: random_string }
    internal_subnet:
        type: OS::Neutron::Subnet
        properties:
            network_id: { get_resource: internal_net }
            cidr: 192.168.42.0/24
            gateway_ip: 192.168.42.1
            enable_dhcp: true
            dns_nameservers: { get_param: dns_nameservers }
            name:
                str_replace:
                    template: $prefix$random-subnet
                    params:
                        $prefix: { get_param: resource_prefix }
                        $random: { get_resource: random_string }
    internal_router:
        type: OS::Neutron::Router
        properties:
            admin_state_up: true
            external_gateway_info: { "network": { get_param: public_network_id }}
            name:
                str_replace:
                    template: $prefix$random-router
                    params:
                        $prefix: { get_param: resource_prefix }
                        $random: { get_resource: random_string }
    internal_router_interface:
        type: OS::Neutron::RouterInterface
        properties:
            router_id: { get_resource: internal_router }
            subnet_id: { get_resource: internal_subnet }
    ##### Master #####
    master_port:
        type: OS::Neutron::Port
        properties:
            admin_state_up: true
            network_id: { get_resource: internal_net }
            allowed_address_pairs:
                - ip_address: 10.0.0.0/8
    master_floatingip:
        type: OS::Neutron::FloatingIP
        external_id: { get_param: master_floating_ip }
        properties:
            floating_network: { get_param: public_network_id }
    master_floatingip_association:
        type: OS::Neutron::FloatingIPAssociation
        properties:
            floatingip_id: { get_param: master_floating_ip }
            port_id: { get_resource: master_port }
    master_instance:
        type: OS::Nova::Server
        properties:
            image: { get_param: image }
            flavor: { get_param: master_flavor }
            key_name: { get_param: key_name }
            networks:
                - port: { get_resource: master_port }
            name:
                str_replace:
                    template: $prefix$random-master
                    params:
                        $prefix: { get_param: resource_prefix }
                        $random: { get_resource: random_string }
            user_data_format: SOFTWARE_CONFIG
            user_data: { get_resource: master_user_data }
    master_user_data:
        type: OS::Heat::CloudConfig
        properties:
            cloud_config:
                #cloud-config
                manage_etc_hosts: localhost
                #package_upgrade: true
                packages:
                    - kubeadm=1.8.7-00
                    - kubernetes-cni=0.5.1-00
                    - kubelet=1.8.7-00
                    - kubectl=1.8.7-00
                    #- docker-ce=17.03.2~ce-0~ubuntu-xenial
                apt_sources:
                    docker.list:
                        source: "deb https://download.docker.com/linux/ubuntu xenial stable"
                        key: { get_file: docker.pgp }
                    kubernetes.list:
                        source: "deb http://apt.kubernetes.io/ kubernetes-xenial main"
                        key: { get_file: kubernetes.pgp }
                runcmd:
                    - - 'systemd-run'
                      - '--on-boot=0s'
                      - '--unit=kubeadm-install'
                      - 'bash'
                      - '-c'
                      - str_replace:
                            params:
                                $floatingip: { get_attr: [master_floatingip, floating_ip_address] }
                                $token: { get_attr: [token, value] }
                            template: { get_file: master.sh }

    ##### Slaves #####
    slaves:
        type: OS::Heat::ResourceGroup
        properties:
            count: { get_param: slave_count }
            resource_def:
                type: slave.yaml
                properties:
                    index: "%index%"
                    key_name: { get_param: key_name }
                    image: { get_param: image }
                    flavor: { get_param: slave_flavor }
                    floating_ips: { get_param: slave_floating_ips }
                    name:
                        str_replace:
                            template: $prefix$random-slave-%index%
                            params:
                                $prefix: { get_param: resource_prefix }
                                $random: { get_resource: random_string }
                    internal_net: { get_resource: internal_net }
                    install_script:
                        str_replace:
                            params:
                                $token: { get_attr: [token, value] }
                                $master_ip: { get_attr: [ master_port, fixed_ips, 0, ip_address ] }
                            template: { get_file: slave.sh }
    ##### Token for kubeadm ####
    token_part_1:
        type: OS::Heat::RandomString
        properties:
            length: 6
            character_classes: []
            character_sequences:
                - {min: 6, sequence: "0123456789abcdef"}
    token_part_2:
        type: OS::Heat::RandomString
        properties:
            length: 16
            character_classes: []
            character_sequences:
                - {min: 16, sequence: "0123456789abcdef"}
    token:
        type: OS::Heat::Value
        properties:
            value:
                str_replace:
                    template: $part1.$part2
                    params:
                        $part1: { get_resource: token_part_1 }
                        $part2: { get_resource: token_part_2 }
